@page "/AddTransaction"
@using UTracker.Models
@inject UserService UserService
@inject NavigationManager NavigationManager

<!-- Search Bar -->
<div class="form-group">
    <label for="search">Search Transactions</label>
    <InputText id="search" class="form-control" @bind-Value="SearchTerm" />
</div>

<h3>Filter Transactions</h3>
<div class="row">
    <div class="col-md-3">
        <label for="filterTransactionType">Transaction Type</label>
        <InputSelect id="filterTransactionType" class="form-control" @bind-Value="filterTransactionType">
            <option value="">All</option>
            <option value="Debit">Debit</option>
            <option value="Credit">Credit</option>
        </InputSelect>
    </div>

    <div class="col-md-3">
        <label for="filterCategory">Category</label>
        <InputSelect id="filterCategory" class="form-control" @bind-Value="filterCategory">
            <option value="">All</option>
            <option value="Monthly">Monthly</option>
            <option value="Salary">Salary</option>
            <option value="Rent">Rent</option>
            <option value="Groceries">Groceries</option>
            <option value="Self-care">Self-care</option>
            <option value="Other">Other</option>
        </InputSelect>
    </div>

    <div class="col-md-3">
        <label for="filterTitle">Sort by Title</label>
        <InputSelect id="filterTitle" class="form-control" @bind-Value="filterTitleOrder">
            <option value="Ascending">Ascending</option>
            <option value="Descending">Descending</option>
        </InputSelect>
    </div>

    <div class="col-md-3">
        <label for="filterDateRange">Date Range</label>
        <div class="d-flex">
            <InputDate id="filterStartDate" class="form-control me-2" @bind-Value="filterStartDate" />
            <InputDate id="filterEndDate" class="form-control" @bind-Value="filterEndDate" />
        </div>
    </div>
</div>
<button class="btn btn-primary mt-3" @onclick="ApplyFilters">Apply Filters</button>
<button class="btn btn-secondary mt-3 ms-2" @onclick="ClearFilters">Clear Filters</button>

<hr />

<h3>Transaction Summary</h3>
@if (filteredTransactions.Any())
{
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Title</th>
                <th>Transaction Type</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Category</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var trans in filteredTransactions)
            {
                <tr class="@GetTransactionRowClass(trans.TransactionType)">
                    <td>@trans.Title</td>
                    <td>@trans.TransactionType</td>
                    <td>@trans.Amount</td>
                    <td>@trans.Date.ToShortDateString()</td>
                    <td>@trans.Category</td>
                    <td>@trans.Notes</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No transactions available.</p>
}

<h3>Add Transaction</h3>

<div class="alert alert-success" style="display:@(string.IsNullOrEmpty(successMessage) ? "none" : "block")">
    @successMessage
</div>

<div class="alert alert-danger" style="display:@(string.IsNullOrEmpty(errorMessage) ? "none" : "block")">
    @errorMessage
</div>

<EditForm Model="@transaction" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="title">Title</label>
        <InputText id="title" class="form-control" @bind-Value="transaction.Title" />
    </div>

    <div class="form-group">
        <label for="transactionType">Transaction Type</label>
        <InputSelect id="transactionType" class="form-control" @bind-Value="transaction.TransactionType">
            <option value="Type Option">Select Transaction Type</option>
            <option value="Debit">Debit</option>
            <option value="Credit">Credit</option>
        </InputSelect>
    </div>

    <div class="form-group">
        <label for="amount">Amount</label>
        <InputNumber id="amount" class="form-control" @bind-Value="transaction.Amount" />
    </div>

    <div class="form-group">
        <label for="date">Date</label>
        <InputDate id="date" class="form-control" @bind-Value="transaction.Date" />
    </div>

    <div class="form-group">
        <label for="category">Category</label>
        <InputSelect id="category" class="form-control" @bind-Value="transaction.Category">
            <option value="Category">Category</option>
            <option value="Monthly">Monthly</option>
            <option value="Salary">Salary</option>
            <option value="Rent">Rent</option>
            <option value="Groceries">Groceries</option>
            <option value="Self-care">Self-care</option>
            <option value="Other">Other</option>
        </InputSelect>
    </div>

    <div class="form-group">
        <label for="notes">Notes</label>
        <InputTextArea id="notes" class="form-control" @bind-Value="transaction.Notes" />
    </div>

    <button type="submit" class="btn btn-primary">Add Transaction</button>
    <button type="button" class="btn btn-secondary" @onclick="ResetForm">Reset</button>
    <button type="button" class="btn btn-danger" @onclick="DeleteAllTransactions">Delete All Transactions</button>

</EditForm>

<hr />

@code {
    private string filterTransactionType = string.Empty;
    private string filterCategory = string.Empty;
    private string filterTitleOrder = "Ascending";
    private DateTime? filterStartDate = null;
    private DateTime? filterEndDate = null;
    private List<AddTransaction> transactions = new();
    private List<AddTransaction> filteredTransactions = new();
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;
    private decimal totalCredit = 0;
    private decimal totalDebit = 0;
    private string searchTerm;
    private string SearchTerm
    {
        get => searchTerm;
        set
        {
            searchTerm = value;
            FilterTransactions();
        }
    }

    private void FilterTransactions()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredTransactions = new List<AddTransaction>(transactions); // Show all transactions
        }
        else
        {
            filteredTransactions = transactions
                .Where(t => t.Title != null && t.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadTransactions();
    }

    private async Task LoadTransactions()
    {
        transactions = await UserService.GetAllTransactions();
        CalculateTotals();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredTransactions = transactions
            .Where(t =>
                (string.IsNullOrEmpty(filterTransactionType) || t.TransactionType == filterTransactionType) &&
                (string.IsNullOrEmpty(filterCategory) || t.Category == filterCategory) &&
                (!filterStartDate.HasValue || t.Date >= filterStartDate.Value) &&
                (!filterEndDate.HasValue || t.Date <= filterEndDate.Value))
            .ToList();

        filteredTransactions = filterTitleOrder switch
        {
            "Ascending" => filteredTransactions.OrderBy(t => t.Title).ToList(),
            "Descending" => filteredTransactions.OrderByDescending(t => t.Title).ToList(),
            _ => filteredTransactions
        };
    }

    private void ClearFilters()
    {
        filterTransactionType = string.Empty;
        filterCategory = string.Empty;
        filterTitleOrder = "Ascending";
        filterStartDate = null;
        filterEndDate = null;
        ApplyFilters();
    }

    private async Task HandleValidSubmit()
    {
        if (transaction.TransactionType == "Debit" && transaction.Amount > totalCredit)
        {
            await DisplayErrorMessage("Error: Debit amount exceeds available credit.");
            return;
        }

        if (transaction.TransactionType == "Debit")
            totalDebit += transaction.Amount;
        else if (transaction.TransactionType == "Credit")
            totalCredit += transaction.Amount;

        await UserService.AddTransaction(transaction);
        await LoadTransactions();
        transaction = new AddTransaction();
        await DisplaySuccessMessage("Transaction successfully added!");
    }

    private void ResetForm()
    {
        transaction = new AddTransaction();
    }

    private async Task DeleteAllTransactions()
    {
        var result = await UserService.DeleteAllTransactions();
        if (result > 0)
        {
            await DisplaySuccessMessage("All transactions have been deleted!");
            await LoadTransactions();
        }
        else
        {
            await DisplayErrorMessage("No transactions found to delete.");
        }
    }

    private string GetTransactionRowClass(string transactionType) =>
        transactionType switch
        {
            "Debit" => "table-danger",
            "Credit" => "table-success",
            _ => ""
        };

    private async Task DisplaySuccessMessage(string message)
    {
        successMessage = message;
        StateHasChanged();
        await Task.Delay(3000);
        successMessage = string.Empty;
        StateHasChanged();
    }

    private async Task DisplayErrorMessage(string message)
    {
        errorMessage = message;
        StateHasChanged();
        await Task.Delay(3000);
        errorMessage = string.Empty;
        StateHasChanged();
    }

    private void CalculateTotals()
    {
        totalCredit = transactions.Where(t => t.TransactionType == "Credit").Sum(t => t.Amount);
        totalDebit = transactions.Where(t => t.TransactionType == "Debit").Sum(t => t.Amount);
    }

    private AddTransaction transaction = new AddTransaction();
}



